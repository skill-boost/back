name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v3

      # DockerHub 로그인
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Docker 이미지 빌드 & 푸시
      - name: Build and Push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }}

#      # Github Actions IP 가져오기
#      - name: Get Github Actions IP
#        id: ip
#        uses: haythem/public-ip@v1.2
#
#      # AWS 보안 그룹에 동적으로 IP 추가
#      - name: Add Github Actions IP to Security group
#        run: |
#          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SECRET_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
#        env:
#          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          AWS_DEFAULT_REGION: ap-northeast-2

      # EC2 SSH → k3s에 Secret 생성 & Deployment 업데이트
      - name: Deploy to K3s via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # -- db-secret 생성 --
            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: db-secret
              namespace: default
            type: Opaque
            stringData:
              DB_URL: "${{ secrets.DB_URL }}"
              DB_USERNAME: "${{ secrets.DB_USERNAME }}"
              DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"
            EOF

            # -- app-secret 생성 --
            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: app-secret
              namespace: default
            type: Opaque
            stringData:
              JWT_SECRET_KEY: "${{ secrets.JWT_SECRET_KEY }}"
              GITHUB_CLIENT_SECRET: "${{ secrets.GITHUB_CLIENT_SECRET }}"
            EOF

            # -- Deployment 이미지 업데이트 (자동으로 롤링 업데이트 시작) --
            kubectl set image deployment/skill-boost-app \
            skill-boost-app=${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }} \
            --record
      
            # -- 롤링 업데이트 완료 대기 --
            kubectl rollout status deployment/skill-boost-app --timeout=5m
      
            # -- 배포 결과 확인 --
            kubectl get pods -l app=skill-boost-app
            echo "✅ Deployment successful!"

      # AWS 보안 그룹에서 IP 제거
#      - name: Remove Github Actions IP from security group
#        if: always()
#        run: |
#          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SECRET_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
#        env:
#          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          AWS_DEFAULT_REGION: ap-northeast-2
