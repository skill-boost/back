name: CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v3

      # DockerHub 로그인
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Docker 이미지 빌드 & 푸시
      - name: Build and Push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }}

      # EC2 SSH → k3s에 Secret 생성 & Deployment 업데이트
      - name: Deploy to K3s via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/skill-boost   # k8s YAML 저장 경로

            # -- db-secret 생성 --
            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: db-secret
              namespace: default
            type: Opaque
            stringData:
              DB_URL: "${{ secrets.DB_URL }}"
              DB_USERNAME: "${{ secrets.DB_USERNAME }}"
              DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"
            EOF

            # -- app-secret 생성 --
            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: app-secret
              namespace: default
            type: Opaque
            stringData:
              JWT_SECRET_KEY: "${{ secrets.JWT_SECRET_KEY }}"
              GITHUB_CLIENT_SECRET: "${{ secrets.GITHUB_CLIENT_SECRET }}"
            EOF

            # -- Docker 이미지 pull 및 Deployment 업데이트 --
            docker pull ${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }}
            kubectl set image deployment/skill-boost-app skill-boost-app=${{ secrets.DOCKER_USERNAME }}/skill-boost:${{ github.sha }}

            # -- 롤링 업데이트 완료 대기 및 Pod 재시작 (Secret 변경 반영) --
            kubectl rollout status deployment/skill-boost-app
            kubectl rollout restart deployment/skill-boost-app
